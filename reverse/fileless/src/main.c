#include <stdio.h>
#include <sys/mman.h>
#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>

#include "antidebug.h"

typedef unsigned char BYTE;

BYTE code_enc[] = "\xf0\x84\x19\x19\x19\x3c\xd7\xe9\x19\x3c\x77\xe9\x19\x3c\xa7\xe9\x19\x3c\xc7\xe9\x19\x3c\x7\xea\x19\x3c\xc7\xe8\x19\x3c\x37\xeb\x19\x3c\xf7\xee\x19\x3c\xf7\xea\x19\x3c\x47\xe8\x19\x3c\xa7\xeb\x19\x3c\x97\xeb\x19\x3c\xb7\xee\x19\x3c\xe7\xea\x19\x3c\xf7\xea\x19\x3c\x47\xe8\x19\x3c\x87\xea\x19\x3c\x47\xeb\x19\x3c\x67\xeb\x19\x3c\x87\xee\x19\x3c\x47\xe8\x19\x3c\xd7\xeb\x19\x3c\xa7\xee\x19\x3c\x77\xeb\x19\x3c\xe7\xeb\x19\x3c\x77\xeb\x19\x3c\xe7\xeb\x19\x3c\x87\xea\x19\x3c\x87\xea\x19\x3c\x47\xe8\x19\x3c\xb7\xea\x19\x3c\xa7\xeb\x19\x3c\x87\xeb\x19\x3c\x7\xeb\x19\x3c\xe7\xeb\x19\x3c\x97\xea\x19\x3c\xe7\xee\x19\x3c\x47\xee\x19\x3c\x67\xea\x19\xf0\x4c\x51\x90\xfc\xf1\x54\x19\x19\x19\x51\x9a\xe1\x3e\x6c\x5b\x73\x19\x51\x90\xce\x92\x5c\xe5\x9a\xe1\x3e\x65\x1b\xf2\x35\x51\x28\xd0\x93\x16\x51\xd8\xf8\x15\x51\x98\xe8\x3c\xb7\xed\x19\x92\x5c\xe5\x51\x94\x2c\x32\xe6\xe6\xe6\x72\xd9\x1d\x51\x18\xdf\x22\x17\x6c\x16\x51\xe6\xde\xe6\x5c\xe5\xf2\xd3\xa1\x18\x19\x19\x19\xd0\xda\x51\x28\xd9\xd0\xda\x48\x51\x28\xd0\x99\x26\x19\x6d\x11\x51\xe6\xd8\x51\xe6\xde\xf2\xea\x51\x90\xd1\x40\xda";

void __attribute__((constructor)) decrypt()
{
    for (size_t i = 0; i < sizeof(code_enc); ++i)
        code_enc[i] ^= 0x19;
}

void __attribute__((constructor)) debug_break()
{
    setup();
}

int change_perm(void *addr) {
    int page_size = getpagesize();
    addr -= (unsigned long)addr % page_size;
    mprotect(addr, page_size, PROT_WRITE | PROT_EXEC);
    return 0;
}

int main(int argc, char *argv[])
{
    if (argc < 2)
    {
        puts("Usage: ./fileless <flag>");
        return 1;
    }

    int (*check)(char *);
    check = code_enc;
    change_perm(code_enc);

    if (check(argv[1]))
        puts("Congratulations, flag is correct!");
    else
        puts("Nope, try harder!");

    return 0;
}